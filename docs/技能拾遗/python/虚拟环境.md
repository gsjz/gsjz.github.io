# 虚拟环境

神秘的是 `python` 版本大于 `3.12` 还是什么之后，就默认不允许全局 `pip` 下载了。

虚拟环境从一种好习惯变成了一个要求。

## python3-venv

前置安装

```bash
sudo apt update
sudo apt install python3 python3-pip python3-venv
```

然后新建

```bash
python3 -m venv venvname
```

-m 的含义

全称：module

功能：告诉 Python “把某个模块当作脚本来运行”。

效果：相当于在命令行里直接调用模块的入口，而不是去找一个 .py 文件。

-m venv → 调用 Python 内置的 venv 模块

venvname（最后的参数） → 指定虚拟环境目录名

效果：在当前目录下创建一个叫 venvname/ 的虚拟环境文件夹

### 激活

`venvname` 这个文件夹下面，有一个 `bin/activate` 的可执行文件。接着

=== "linux"

    ```bash
    source venvname/bin/activate
    ```

=== "powershell"

    在 PowerShell 中，激活脚本位于 `venvname\Scripts\Activate.ps1`。运行：

    ```powershell
    .\venvname\Scripts\Activate.ps1
    ```

    激活后，命令行前面会出现 (venvname) 提示符，表示你已经进入虚拟环境。

### 导出

即然这个虚拟环境的格式还分系统的，怎么统一？

我们直接把版本信息输入到一个 `.txt` 里

```bash
pip freeze > requirements.txt
```

需要虚拟环境的时候通过这个 `.txt` 加载即可

```bash
pip install -r -requirements.txt
```

### de激活

```bash
deactivate
```

## conda

pip + venv 主要安装 Python 包（纯 Python 代码或需要编译的扩展）。如果包依赖于底层系统库（如 libxxx-dev），就可能出现“编译地狱”，需要手动安装编译工具或系统依赖。

Conda 能直接安装 非 Python 依赖，例如：

- CUDA / cuDNN（GPU 加速库）

- MKL / OpenBLAS（数学库）

- gcc / g++ / libstdc++（编译器和运行库）

ffmpeg、graphviz、openssl 等系统工具

这些都是预编译好的二进制包，安装即用，不需要用户自己编译。

因此在机器学习、科学计算、C/C++ 扩展包场景里特别重要。

### miniconda? anaconda?

| 项目         | Conda            | Miniconda           | Anaconda                              |
| ---------- | ---------------- | ------------------- | ------------------------------------- |
| 定义         | **包管理器 + 环境管理器** | **精简发行版（自带 Conda）** | **完整发行版（自带 Conda）**                   |
| 是否包含 Conda | ✅                | ✅                   | ✅                                     |
| 是否包含常用库    | ❌                | ❌（需手动安装）            | ✅（NumPy / SciPy / pandas / sklearn 等） |
| 默认体积       | 极小               | ~100–400 MB         | 3–5 GB                                |
| 适合人群       | 所有需要环境/依赖管理的人    | **开发者 / 进阶用户**      | **初学者 / 教学 / 快速上手**                   |
| 优势         | 通用、跨平台           | **轻量、干净、可控**        | **开箱即用、零配置**                          |
| 劣势         | 只是工具，不能单独用       | 需要自己配环境             | 冗余多、空间占用大                             |


所以我们选择安装 miniconda。通过官网下载即可。

### terminal

安装的过程中，不推荐把 `conda` 加入全局 PATH。因此，系统自带的 `powershell` 等是找不到 `conda` 的。

推荐的做法是使用新安装出来的 `Anaconda Prompt`。（对比来说，我们熟悉的 `cmd` 其实全称是 `Command Prompt` 命令提示符。只不过 `prompt` 在如今的 AI 泡沫中人们逐渐熟知另一个指代了。）

可以分别尝试在不同的 terminal 里输入 `conda --version` 来测试是否可以使用。

```bash
conda --version
```

### 设置环境

打开 `Anaconda Prompt`，默认就会有一个环境 `(base)`。一般不建议直接在这个环境里操作。

通过

```bash
conda env list
```

可以列出已有的虚拟环境。

通过

```bash
conda create -n envname python=3.10
```

创建新的虚拟环境。其中 `-n envname` 指定环境名。后面最好固定一个 python 版本。


通过

```bash
conda activate envname
```

来激活虚拟环境。

同理

```
conda deactivate
```

退出环境。

### 导出环境

```bash
conda env export > environment.yml
```

### 复现环境

```bash
conda env create -f environment.yml
```

???- question "environment.yml 里面还有本机才会存在的 prefix"
    
    environment.yml 文件里常见的 prefix: 字段，其实是 你本机环境的绝对路径（例如 C:\Users\ROG8\miniconda3\envs\myenv）。这个字段在别人机器上通常是 无效的，因为他们的路径不会和你的一样。

    行为解析
    当别人用 conda env create -f environment.yml 时：

    Conda 会尝试在 prefix 指定的路径创建环境。

    如果该路径不存在或没有权限，往往会报错。

    在多数情况下，别人会忽略这个字段，或者 Conda 会 fallback 到默认的 envs 目录。

    在跨机器分享时，真正有用的是：

    name: 字段（环境名称）

    dependencies: 列表（包和版本）

    推荐实践
    删除或忽略 prefix: 字段，只保留 name 和 dependencies。

### 彻底删除虚拟环境

```bash
conda remove -n envname --all
```

### 克隆环境

Conda 不支持直接改名，正确做法：

```bash
conda create -n newenv --clone oldenv
conda remove -n oldenv --all
```

### 安装 CUDA

前面提到 conda 能管理的不止 python 这套东西。

我们以一个我后两天要学的东西的安装作结尾：CUDA。他是由 NVIDIA 提供的，用于加速（它的）GPU。

???- info "CUDA 的构成"

    ```text
        ┌──────────────────────────┐
        │  应用层（PyTorch / C++）  │
        ├──────────────────────────┤
        │  CUDA Runtime (libcudart)│
        │  CUDA Libraries          │  ← cuBLAS / cuDNN / cuFFT / NCCL
        ├──────────────────────────┤
        │  CUDA Driver (libcuda)   │
        ├──────────────────────────┤
        │  NVIDIA GPU 硬件         │
        └──────────────────────────┘
    ```

=== "安装 pytorch 所需要的 CUDA 部分"

    ```bash
    conda install pytorch torchvision torchaudio pytorch-cuda=11.8 -c pytorch -c nvidia
    ```

    ✔ 包含

    libcudart.so / cudart.dll

    cuBLAS

    cuDNN

    cuFFT

    NCCL（多卡通信）

    ❌ 不包含

    nvcc

    CUDA headers（cuda_runtime.h 等）

    Nsight

    编译工具链

    ---

=== "假如我想用 C++ 做 CUDA 编程"

    模式：Conda + CUDA Toolkit（可行但不主流）

    ```bash
    conda install -c nvidia cuda-toolkit
    ```
    你将获得：

    nvcc

    headers

    CUDA libs

    但问题是：

    路径复杂

    CMake / Makefile 很容易踩坑

    和系统 CUDA 混用极易出错

    ---

=== "混合使用"

    模式：C++ + PyTorch（LibTorch / 自定义 CUDA 扩展）

    场景

    C++ 写高性能算子

    Python 只是前端

    类似 PyTorch Extension

    这时：

    PyTorch 自带的 CUDA Runtime 够用

    但你 仍然需要 nvcc 来编译

    因此你需要：

    系统 CUDA Toolkit（nvcc）+ Conda PyTorch（pytorch-cuda）

    ---


todo: 学习 CUDA 编程后回来完善。